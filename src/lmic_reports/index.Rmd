---
title: ""
header-includes: \usepackage{caption}
date: ""
output:
  html_document:
    keep_md: yes
    self_contained: yes
    css: styles.css
    theme: cosmo
    fig_caption: TRUE
  pdf_document: 
    fig_caption: true
    includes: 
      before_body: footer.tex
  word_document:
    df_print: kable
    fig_caption: yes
    fig_height: 4
    fig_width: 6
    highlight: tango
    reference_docx: template.docx
params:
   r_list: NA
   replicates: 10
   data: NA
   country: NA
---

```{js, echo = FALSE}

if ($(window).width() < 768) {
$('.dropdown-menu a.dropdown-toggle').on('click', function(e) {
if (!$(this).next().hasClass('show')) {
$(this).parents('.dropdown-menu').first().find('.show').removeClass("show");
}



var $subMenu = $(this).next(".dropdown-menu");
if (!$subMenu.hasClass('show')) {
$subMenu.addClass('show');
$subMenu.show();
} else {
$subMenu.removeClass('show');
$subMenu.hide();
}



$(this).parents('li.nav-item.dropdown.show').on('hidden.bs.dropdown', function(e) {
$('.dropdown-submenu .show').removeClass("show");
});



return false;
});
}

```

```{r echo=FALSE, message=FALSE, warning=FALSE}

# grab inputs
start <- 10
replicates <- params$replicates
data <- params$data 
country <- params$country
saveRDS(country,"/home/oj/Desktop/country.rds")
format <- knitr::opts_knit$get("rmarkdown.pandoc.to")
figRef <- function(caption) {
  if(format == "latex") {
    gsub("Figure \\d: ","",caption)
  } else {
    caption
  }
}


fig_height <- function(pdf = 4, html = 6) {
  if(format == "latex") {
    pdf
  } else {
    html
  }
}

fig_center <- function() {
  if(format == "latex") {
    "default"
  } else {
    "center"
  }
}


if(data$deaths[1] >= 10) {
  show_sentence <- "" 
} else  {
  show_sentence <-  paste("**N.B. ", country, " is not shown in the following plot as only ", data$deaths[1]," deaths have been reported to date**")
}


```

```{r ecdc prep, echo = FALSE, collapse=TRUE, warning=FALSE}

## Summaries
form <- function(x) {
  paste0(format(round(x[[1]]), big.mark=","),
         " (95% CI: ", format(round(x[[2]]), big.mark=","),
         "-", format(round(x[[3]]), big.mark=","),")")
}

# what was the date being calibrated to
if(max(data$deaths) < 10) {
  date_0 <- Sys.Date()
} else {
  date_0 <- data$date[max(which(data$deaths>10))]
}

## -----------------------------------------------------------------------------
## totals unmitigated
## -----------------------------------------------------------------------------

infections <- format_output(r_list[[1]], "infections", date_0 = date_0)
infections <- infections[infections$t <= 0 & infections$t > -28, ]
infs <- group_by(infections, replicate) %>% 
  summarise(tot = sum(y)) %>% 
  summarise(inf_tot = mean(tot), 
            inf_min = t.test(tot)$conf.int[1],
            inf_max = t.test(tot)$conf.int[2])

hospital <- format_output(r_list[[1]], "hospital_demand")
hosp_today <- group_by(hospital[hospital$t==0,], replicate) %>% 
  summarise(tot = sum(y)) %>% 
  summarise(i_tot = mean(tot), 
            i_min = t.test(tot)$conf.int[1],
            i_max = t.test(tot)$conf.int[2])

hosp_14 <- group_by(hospital[hospital$t==14,], replicate) %>% 
  summarise(tot = sum(y)) %>% 
  summarise(i_tot = mean(tot), 
            i_min = t.test(tot)$conf.int[1],
            i_max = t.test(tot)$conf.int[2])

icu <- format_output(r_list[[1]], "ICU_demand")
icu_today <- group_by(icu[icu$t==0,], replicate) %>% 
  summarise(tot = sum(y)) %>% 
  summarise(i_tot = mean(tot), 
            i_min = t.test(tot)$conf.int[1],
            i_max = t.test(tot)$conf.int[2])

icu_14 <- group_by(icu[icu$t==14,], replicate) %>% 
  summarise(tot = sum(y)) %>% 
  summarise(i_tot = mean(tot), 
            i_min = t.test(tot)$conf.int[1],
            i_max = t.test(tot)$conf.int[2])

deaths <- format_output(r_list[[1]], "deaths")
deaths_14 <- group_by(deaths[deaths$t==14,], replicate) %>% 
  summarise(tot = sum(y)) %>% 
  summarise(i_tot = mean(tot), 
            i_min = t.test(tot)$conf.int[1],
            i_max = t.test(tot)$conf.int[2])

## -----------------------------------------------------------------------------
## totals mitigated
## -----------------------------------------------------------------------------

infections_mit <- format_output(r_list[[2]], "infections", date_0 = date_0)
infections_mit <- infections_mit[infections_mit$t <= 0 & infections_mit$t > -28, ]
infs_mit <- group_by(infections_mit, replicate) %>% 
  summarise(tot = sum(y)) %>% 
  summarise(inf_tot = mean(tot), 
            inf_min = t.test(tot)$conf.int[1],
            inf_max = t.test(tot)$conf.int[2])

hospital_mit <- format_output(r_list[[2]], "hospital_demand")
hosp_today_mit <- group_by(hospital_mit[hospital_mit$t==0,], replicate) %>% 
  summarise(tot = sum(y)) %>% 
  summarise(i_tot = mean(tot), 
            i_min = t.test(tot)$conf.int[1],
            i_max = t.test(tot)$conf.int[2])

hosp_14_mit <- group_by(hospital_mit[hospital_mit$t==14,], replicate) %>% 
  summarise(tot = sum(y)) %>% 
  summarise(i_tot = mean(tot), 
            i_min = t.test(tot)$conf.int[1],
            i_max = t.test(tot)$conf.int[2])

icu_mit <- format_output(r_list[[2]], "ICU_demand")
icu_today_mit <- group_by(icu_mit[icu_mit$t==0,], replicate) %>% 
  summarise(tot = sum(y)) %>% 
  summarise(i_tot = mean(tot), 
            i_min = t.test(tot)$conf.int[1],
            i_max = t.test(tot)$conf.int[2])

icu_14_mit <- group_by(icu_mit[icu_mit$t==14,], replicate) %>% 
  summarise(tot = sum(y)) %>% 
  summarise(i_tot = mean(tot), 
            i_min = t.test(tot)$conf.int[1],
            i_max = t.test(tot)$conf.int[2])

deaths_mit <- format_output(r_list[[2]], "deaths")
deaths_14_mit <- group_by(deaths_mit[deaths_mit$t==14,], replicate) %>% 
  summarise(tot = sum(y)) %>% 
  summarise(i_tot = mean(tot), 
            i_min = t.test(tot)$conf.int[1],
            i_max = t.test(tot)$conf.int[2])

```

## Situation Report for COVID-19: `r country`, `r format(Sys.Date(), "%Y-%m-%d")`

<br> 

This report uses data from the ECDC database of COVID-19 deaths reported. We use mathematical modelling techniques (see [Report 12](https://www.imperial.ac.uk/mrc-global-infectious-disease-analysis/covid-19/report-12-global-impact-covid-19/) for further details) to estimate the number of people that have been infected and to make short-term projections for future healthcare needs.

The current version of this report does not capture the impact that interventions that have been put in place will have had on the course of the epidemic. The short-term projections may therefore be higher than the actual need for countries that currently have widescale and effective social distancing measures in place.

<br> 

### Epidemiological Situation

As of `r format(Sys.Date(), "%Y-%m-%d")` there have been `r format(data$cases[1], big.mark=",")` cases and `r format(data$deaths[1], big.mark=",")` deaths reported. The figure below shows the cumulative reported as a function of the time since the 10th death was reported. Dashed lines show the expected trajectory for different doubling times of the epidemic. For example, with a doubling time of 3 days, if there are currently a total of 20 deaths reported, we would expect there to be 40 deaths in total reported in 3 days-time, 80 deaths in 6 days-time, 160 deaths in 9 days-time etc. For most epidemics, in the absence of interventions, we expect a doubling time of 3-4 days for this disease. `r show_sentence`

<br>

```{r fig1, echo = FALSE, collapse=TRUE, message = FALSE, warning = FALSE, fig.cap=figRef("**Figure 1: Cumulative Deaths since 10 deaths.** Note if 10 deaths are yet to be reported, country will not be shown."), fig.align=fig_center()}

cumulative_deaths_plot(country = country)

```

\newpage

<br>

### COVID-19 Transmission Modelling

We assume that the deaths reported to date provide the best indication of the stage of the epidemic. Our current working estimate is that 1 death indicates that approximately 100 people will have been infected with the other 99 recovering (based on an infection fatality ratio of ~1%). These infections will have happened approximately 15 days previously â€“ capturing a 5-day period from infection to onset of symptoms (the incubation period), 4 days from onset of symptoms to hospitalisation, and 6 days in hospital before death. With a 3-day doubling time, 100 infections that occurred 15 days ago will have generated 200 infections 12 days ago, 400 infections 9 days ago, 800 infections 6 days ago and 1,600 infections 3 days ago resulting in approximately 3,200 infections at the time the first death is observed.

To explore this, we explore two scenarios:

1. Countries with less than 10 deaths are likely experiencing stuttering transmission. In these countries we fit to the cumlative number of deaths to date, assuming that no interventions have been put in place before today. 
2. Countries with more than 10 deaths are likely to have instigated some form of social distancing or case isolation in response. In these countries we introduce a 50% reduction in transmission starting from the day that 10 deaths were reported. 

In both scenarios we assume that 100% of COVID-19 related deaths have been reported. Using our [mathematical model](https://github.com/mrc-ide/squire) that formalises this approach, the figure below shows our estimate of the number of people infected over the past 4 weeks. We estimate that there has been a total of `r form(infs)` infections over the past 4 weeks.

The bar charts show, for comparison, the number of reported cases. It should be noted that the estimated infections may include both asymptomatic and mild cases that would not necessarily be identified through surveillance. The right-hand plot shows these data on a different scale as the estimated infections are likely to be much larger than the reported cases.

The figure below shows the estimated number of people infected and number of symptomatic cases over the past 4 weeks.

<br>

```{r case plot, echo = FALSE, collapse=TRUE, message = FALSE, warning = FALSE,  fig.cap=figRef("**Figure 2: Daily number of infections estimated by fitting to the current total of deaths.** Reported cases are shown in red. Model estimated cases are shown in blue (dark blue 50% interquartile range, light blue 95% quantile)."), fig.width=10, fig.height=6}

suppressMessages(cases_plot(r_list[[1]], data, date_0))

```

<br>

### Short-term Epidemic Scenarios

We make the following short-term projections of healthcare demand under the the following three scenarios:

1. Scenario 1. The epidemic continues to grow exponentially at the current rate. 
2. Scenario 2. Countries will scale up interventions. In countries with less than 10 deaths, a 50% reduction in transmission is introduced. In countries with more than 10 deaths, a further 20% reduction in transmission is introduced (overall a 70% reduction from baseline transmission).

Conseqently, these predictions have two major caveats:

* The projections do not consider that more interventions may be put in place in the coming weeks. 
* The projections assume that 100% of COVID-19 related deaths have been reported.

We estimate that over the next 2 weeks demand for hospital beds will grow from `r form(hosp_today)` patients requiring treatment with high-pressure oxygen at the current date to `r form(hosp_14)` by `r format(Sys.Date() + 14, "%Y-%m-%d")` if no interventions are introduced (Scenario 1). Similarly, we estimate that over the next 2 weeks demand for critical care (ICU) beds will grow from `r form(icu_today)` patients requiring treatment with mechanical ventilation at the current date to `r form(icu_14)` by `r format(Sys.Date() + 14, "%Y-%m-%d")`. These projections assume that approximately 5% of all infections will require treatment with high-pressure oxygen  and that approximately 30% of hospitalised cases will require require treatment with mechanical ventilation (based on analysis of ongoing epidemics in Europe). 

If interventions are scaled up (Scenario 2), the demand for hospital beds will grow from `r form(hosp_today_mit)` patients requiring treatment with high-pressure oxygen at the current date to `r form(hosp_14_mit)` by `r format(Sys.Date() + 14, "%Y-%m-%d")`. Similarly, we estimate that over the next 2 weeks demand for critical care (ICU) beds will grow from `r form(icu_today_mit)` patients requiring treatment with mechanical ventilation at the current date to `r form(icu_14_mit)` by `r format(Sys.Date() + 14, "%Y-%m-%d")`. 

```{r healthcare plots, echo = FALSE, collapse=TRUE, message = FALSE, warning = FALSE, fig.cap=figRef("**Figure 3: Healthcare demands in the next 2 weeks.** Individuals needing an ICU bed are predicted to need mechanical ventilation."), fig.width=10, fig.height=fig_height(3,4.5)}

#suppressMessages(healthcare_plot(r_list[[1]], data))
if(max(data$deaths) < 10) {
  scens <- c("Unmitigated","Mitigation (50% reduction from today)")
} else {
  scens <- c("Mitigation\n(50% transmission decrease at 10 deaths)",
             "Mitigation+\n(Same + additional from 20% Today)")
}

get <- format_output(r_list[[1]],"hospital_demand",reduce_age = TRUE,date_0 = date_0)
suppressMessages(
  projection_plotting(r_list,scenarios = scens,
                      var_select = c("hospital_demand","ICU_demand"),
                      date_0 = date_0,
                      x_var = "date", 
                      add_parms_to_scenarios = FALSE) + 
    scale_x_date(limits = c(Sys.Date(),Sys.Date()+14)) +
    ylim(c(0,max(get$y[get$date == Sys.Date()+14])))
)
```

<br>

Assuming a severity pattern by age that is consistent with that observed in China, Europe and the U.S to date, we estimate that there could be `r form(deaths_14)` deaths on `r format(Sys.Date() + 14, "%Y-%m-%d")`. The expected trajectory for cumulative deaths is shown in the figure below along with the bar chart of reported deaths.

```{r death forecast plots, echo = FALSE, collapse=TRUE, warning=FALSE, message=FALSE, fig.cap=figRef("**Figure 4: Cumulative Deaths estimated by fitting to the current total of deaths.** Reported deaths are shown in red. Model estimated deaths are shown in blue (dark blue 50% interquartile range, light blue 95% quantile)."), fig.width=10, fig.height=fig_height(3.75,6)}
#suppressMessages(deaths_plot(r_list[[1]], data))

get <- format_output(r_list[[1]],"D",reduce_age = TRUE,date_0 = date_0)
suppressMessages(
   projection_plotting(r_list,scenarios = scens,
                      var_select = c("D"),
                      date_0 = date_0,
                      x_var = "date", 
                      ylab = "Cumulative Deaths",
                      add_parms_to_scenarios = FALSE) + 
    scale_x_date(limits = c(Sys.Date(),Sys.Date()+14)) +
     scale_y_log10(limits = c(max(data$deaths),max(get$y[get$date == Sys.Date()+14])))
  
)
```

<br>